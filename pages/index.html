<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VMolberte</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" href="../styles/index.css" />
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1><i class="fas fa-dna"></i> VMolberte</h1>
            <p>Как ICDMS, только на JS.</p>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item active" data-page="main">
                <i class="fas fa-home"></i>
                <span>Рисовалка</span>
            </div>
            <div class="menu-item" data-page="instruction">
                <i class="fas fa-book"></i>
                <span>Инструкция</span>
            </div>
            <div class="menu-item" data-page="whatsnew">
                <i class="fas fa-newspaper"></i>
                <span>Новости</span>
            </div>
            <div class="menu-item" data-page="colors">
                <i class="fa-solid fa-palette"></i>
                <span>Цвета</span>
            </div>
            <div id="reportMenu" class="menu-item" data-page="report" style="visibility: hidden;">
                <i class="fa-solid fa-file-code"></i>
                <span>Отчёт по запуску</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Main Page -->
        <div id="main" class="page active">
            <div class="page-header">
                <h2>Визуализация данных</h2>
                <p>Выберите файл на компьютере и настройте необходимые параметры</p>
            </div>

            <div class="file-upload-container">
                <div>
                    <div class="file-upload-area" id="fileUploadArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>Выбрать файл</h3>
                        <p>Нажмите для поиска</p>
                        <input type="file" id="fileInput" class="file-input">
                        <div class="file-name" id="fileName">Файлы не выбраны</div>
                    </div>
                </div>
                <div class="buttons-area" id="buttonsArea">
                    <button class="draw-button" id="clearFP">Очистить</button>
                    <div class="selector-group">
                        <select id="mergeKey">
                            <option value="">Ключ для объединения файлов не выбран</option>
                        </select>
                        
                    </div>
                </div>
            </div>
            <div class="content-blocks">
                <!-- Content Block 1 -->
                <div class="content-block">
                    <div class="block-header">
                        <i class="fas fa-chart-line"></i>
                        <h3>Тип графиков и детали</h3>
                    </div>
                    <div class="selectors">
                        <div class="selector-group">
                            <label for="selectGraphType">Тип графиков</label>
                            <select id="selectGraphType">
                                <option value="quickReport">Быстрый отчёт</option>
                                <option value="quickReportEnrichment">Быстрый отчёт по обогащению</option>
                                <option value="perTarget">Сводный по per-target</option>
                                <option value="box">Диаграмма размаха</option>
                                <option value="scatter">Точечная диаграмма</option>
                                <option value="violin">Скрипичная диаграмма</option>
                            </select>
                        </div>
                        <div class="selector-group" style="display: inline;">
                            <input type="checkbox" id="boxpoints" value="all" checked />
                            <label for="boxpoints">Показывать все точки (боксплот)</label>
                        </div>
                        <div class="selector-group" style="display: inline;">
                            <input type="checkbox" id="outliers" value="all" checked />
                            <label for="boxpoints">Показывать выбросы (боксплот)</label>
                        </div>

                    </div>
                </div>

                <div class="content-block">
                    <div class="block-header">
                        <i class="fa-regular fa-object-group"></i>
                        <h3>Раскрашиваем и группируем</h3>
                    </div>
                    <div class="selectors">
                        <div class="selector-group">
                            <label for="selectGroupType">Сгруппировать по</label>
                            <select id="selectGroupType">
                                <option value="">Не выбран</option>
                                <option value="filename">Имени файла</option>
                            </select>
                        </div>
                        <div class="selector-group">
                            <label for="selectGroupColor">Раскрасить по</label>
                            <select id="selectGroupColor">
                                <option value="">Не выбран</option>
                                <option value="filename">Имени файла</option>
                            </select>
                        </div>

                    </div>
                </div>

                <!-- Content Block 2 -->
                <div class="content-block">
                    <div class="block-header">
                        <i class="fa-solid fa-square-poll-vertical"></i>
                        <h3>Метрики для визуализации</h3>
                    </div>
                    <div class="selectors">
                        <div class="selector-group">
                            <label for="metric_1">Метрика 1 (y)</label>
                            <select id="metric_1">
                                <option value="">Не выбрана</option>
                            </select>
                        </div>
                        <div class="selector-group">
                            <label for="metric_2">Метрика 2 (x)</label>
                            <select id="metric_2">
                                <option value="">Не выбрана</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="action-container">
                    <button class="draw-button" id="drawButton">
                        <i class="fa-solid fa-brush"></i> Нарисовать
                    </button>
                    <div class="progress-container">
                        <svg width="120" height="120" class="progress-circle">
                            <defs>
                                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#667eea" />
                                    <stop offset="100%" stop-color="#764ba2" />
                                </linearGradient>
                            </defs>
                            <circle cx="60" cy="60" r="54" class="progress-background"></circle>
                            <circle cx="60" cy="60" r="54" class="progress-bar" id="progressBar"></circle>
                        </svg>
                        <div class="progress-text" id="progressText">0%</div>
                    </div>
                </div>
            </div>

            <!-- Content Block 4 -->
            <div class="content-block" style="grid-column: span 3; margin-bottom: 20px;" id="detailBlock">
                <div class="block-header">
                    <i class="fa-solid fa-wrench"></i>
                    <h3>Дополнительные элементы (нажать для раскрытия)</h3>
                </div>
                <div class="selectors">
                    <div class="selector-group">
                        <div class="styler" style="display: none;">
                            <label for="verticalLine">Добавить линию</label>
                            <input id="lineName" placeholder="Укажите имя линии (опционально)" style="grid-column-start:2; grid-row-start:1;">
                            <select id="showLegend" style="grid-column-start:3; grid-row-start:1;">
                                <option value="false">Не отображать в легенде</option>
                                <option value="true">Отображать в легенде</option>
                            </select>
                            <select id="lineDirection" style="grid-column-start:1; grid-row-start:2;">
                                <option value="">Направление линии</option>
                                <option value="vertical">Вертикальная</option>
                                <option value="horizontal">Горизонтальная</option>
                            </select>
                            <select id="verticalSelect" style="grid-column-start:1; grid-row-start:3;">
                                <option value="">Тип линии</option>
                                <option value="threshold">Пороговая</option>
                                <option value="freeSize">Свободный размер</option>
                                <option value="pValue">P-value</option>
                            </select>
                            <!-- Инпуты -->
                            <input id="fromWhere" placeholder="Откуда" style="grid-column-start:2; grid-row-start:2;">
                            <input id="toWhere" placeholder="Докуда" style="grid-column-start:3; grid-row-start:2;">
                            <input id="whereLine" placeholder="Где" style="grid-column-start:4; grid-row-start:2;">
                            
                            <select id="verticalColorSelect" style="grid-column-start:2; grid-row-start:3;">
                                <option value="">Цвет линии</option>
                            </select>
                            <select id="verticalStyleSelect" style="grid-column-start:3; grid-row-start:3;">
                                <option value="">Стиль линии</option>
                                <option value="dash">Пунктир</option>
                                <option value="solid">Сплошная</option>
                                <option value="dot">Точки</option>
                            </select>
                            <button id="addVert" style="grid-column-start:4; grid-row-start:3;">Добавить</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-block">
                <div class="block-header">
                    <i class="fa-solid fa-splotch"></i>
                    <h3 id="graphTitle">Тут мог бы быть Ваш график</h3>
                </div>
                <div id="plotlyPlot">
                </div>
            </div>
        </div>

        <!-- Instruction Page -->
        <div id="instruction" class="page">
            <div class="page-header">
                <h2>Инструкция</h2>
                <p>Изучите приложение перед началом использования.</p>
            </div>

            <div class="instruction-container">
                <div class="instruction-section">
                    <div class="instruction-header">
                        <i class="fas fa-file-upload"></i>
                        <h3>1. Загрузка данных</h3>
                    </div>
                    <div class="instruction-content">
                        <p>VMolberte поддерживает два формата данных:</p>
                        <ul>
                            <li>CSV-файлы</li>
                            <li>TSV-файлы</li>
                        </ul>
                        <p>Просто нажмите "Выбрать файл", укажите нужные, и приложение автоматически определит расширение и подготовит данные для работы.</p>
                        <p>
                            <i>В отличие от ICDMS</i>, VMolberte поддерживает открытие нескольких файлов,
                            если они находятся в одной директории (можете попробовать и из разных, но у меня не получается).
                        </p>
                        <p>Если требуется открыть несколько файлов из разных директорий, делайте это последовательно, файл за файлом.</p>
                        <p>После успешной загрузки файла будет проиграна короткая анимация - подсветка полей выбора параметров синим цветом означает, что приложение распознало файлы и готово к работе.</p>
                    </div>
                </div>

                <div class="instruction-section">
                    <div class="instruction-header">
                        <i class="fas fa-cogs"></i>
                        <h3>2. Настройка параметров отображения</h3>
                    </div>
                    <div class="instruction-content">
                        <p>Каждый блок параметров содержит знакомые по ICDMS настройки:</p>
                        <ul>
                            <li>Блок "Тип графиков и детали" содержит меню выбора графиков</li>
                            <li>Раздел "Раскрашиваем и группируем" содержит новую функцию - можно сгруппировать по одному столбцу, а раскрасить по другому</li>
                            <li>Блок "Метрики для визуализации" предназначен для указания имён колонок с данными для отображения</li>
                            <li>"Дополнительные элементы" (линии, пороговые линии и др.) могут быть применены к графикам при отображении единичных метрик, но не в режимах отчёта.</li>
                        </ul>
                        <p>Обратите внимание, что, в отличие от ICDMS, в Мольберте отсутствует выбор цветов и "стиля цвета". Теперь для отображения используются 72 уникальных цвета - посмотрите на них на вкладке "цвета".</p>
                    </div>
                </div>

                <div class="instruction-section">
                    <div class="instruction-header">
                        <i class="fas fa-chart-line"></i>
                        <h3>3. Генерация изображений</h3>
                    </div>
                    <div class="instruction-content">
                        <p>После настройки всех нужных параметров:</p>
                        <ul>
                            <li>Нажмите кнопку "Нарисовать"</li>
                            <li>При работе с единичными метриками график отобразится в нижней части текущей страницы</li>
                            <li>При работе с отчётами результат будет вынесен в отдельную вкладку.</li>
                        </ul>
                        <p>Время обработки зависит от объёма данных, но обычно всё происходит достаточно быстро.</p>
                    </div>
                </div>

                <div class="instruction-section">
                    <div class="instruction-header">
                        <i class="fa-solid fa-wrench"></i>
                        <h3>4. Добавление деталей</h3>
                    </div>
                    <div class="instruction-content">
                        <p>После того как Вы отрисовали график по какой-либо метрике, Вам захочется приукрасить график дополнительными линиями.
                            Для этого есть специальная вкладка "Дополнительные элементы", при нажатии на которую Вам раскроется небольшой ассортимент дополнительных опций.</p>
                            <p><b>N.B.</b> Добавление линии p-value запускает длительный расчёт p-value по Манну-Уитни, основываясь на данных по оси Y:
                                <pre><code>
                                    <span class="pythonWord">Python</span>
                                    <span class="pythonFunc">from</span> scipy.stats <span class="pythonFunc">import</span> mannwhitneyu
                                     p_value = mannwhitneyu(data_1, data_2, method='auto', nan_policy='omit')
                                </code></pre>
                            В результате работы функции на графике между заданными боксплотами через некоторое время появится линия с расчитанным p-value.
                        </p>
                    </div>
                </div>

                <div class="instruction-section">
                    <div class="instruction-header">
                        <i class="fas fa-download"></i>
                        <h3>5. Экспорт результатов</h3>
                    </div>
                    <div class="instruction-content">
                        <p>После создания графиков (или отчётов):</p>
                        <ul>
                            <li>Отдельные графики могут быть экспортированы с использованием функционала внутри графика - значок камеры в правом верхнем углу графика</li>
                            <li>Для экспорта отчёта на вкладке отчёта присутствует отдельная кнопка, сохраняющая отчёт в интерактивном виде</li>
                            <li>Делитесь визуализациями с друзьями и коллегами!</li>
                        </ul>

                    </div>
                </div>

                <div class="instruction-section">
                    <div class="instruction-header">
                        <i class="fas fa-question-circle"></i>
                        <h3>6. Стрельба по проблемам</h3>
                    </div>
                    <div class="instruction-content">
                        <p>Частые ошибки и решения:</p>
                        <ul>
                            <li><strong>Не определён разделитель:</strong> убедитесь, что Ваш файл имеет в качестве разделителя либо символ табуляции, либо запятую</li>
                            <li><strong>Странный размер графика в отчёте:</strong> измените ширину окна приложения (откройте на весь экран или наоборот - уменьшите масштаб).</li>
                        </ul>
                        <p>При возникновении ошибок - пишите в telegram (@sxotoffefs)</p>
                        <p>Репозиторий Git - VMolberte</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- What's New Page -->
        <div id="whatsnew" class="page">
            <div class="page-header">
                <h2>Что нового?</h2>
                <p>Будьте в курсе всех обновлений!</p>
            </div>

            <div class="updates-container">
                <div class="update-card">
                    <div class="update-date">
                        <div class="day">День</div>
                        <div class="month">Релиза</div>
                    </div>
                    <div class="update-content">
                        <h3>Первая версия VMolberte!</h3>
                        <p>Состоялся первый релиз приложения!</p>
                        <div class="update-tags">
                            <span class="tag feature">РЕЛИЗ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Колористика -->
        <div id="colors" class="page">
            <div class="page-header">
                <h2>72 уникальных цвета</h2>
                <p>Приложение отображает все графики с использованием этих цветов</p>
            </div>
            <div id="color-grid"></div>

        </div>

        <!-- Отчёт -->
        <div id="report" class="page">
            <div class="page-header">
                <h2>Здесть будет отчёт</h2>
                <p>Сформированный отчёт по стандартным метрикам</p>
                <span style="display: none" id="traceHolder"></span>
                <button class="draw-button" id="downloadAsHtml" style="margin-top: 30px;">
                    <i class="fa-solid fa-download"></i> Скачать как html
                </button>
                <button class="draw-button" id="resetPlotSizes" style="margin-top: 30px;">
                    <i class="fa-solid fa-rotate-left"></i> Обновить графики
                </button>
            </div>
            <div id="report-content">

            </div>
        </div>
    </div>

    
    <script src="../functions/justLoadRenderer.js"></script>
    <script type="module" src="../fileLoadAndPrimProc.js"></script>
    <script type="module" src="../functions/checkRequired.js"></script>
    <script type="module" src="../functions/drawStandartGraph.js"></script>
    <script type="module" src="../functions/detailLines.js"></script>
    <script type="module" src="../functions/portDataForSave.js"></script>
    <script>
        // Навигация
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function () {
                // Remove active class from all menu items and pages
                document.querySelectorAll('.menu-item').forEach(menuItem => {
                    menuItem.classList.remove('active');
                    menuItem.classList.remove('toggling');
                });
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });

                // Add active class to clicked menu item and corresponding page
                this.classList.add('active');
                const pageId = this.getAttribute('data-page');
                if (pageId === 'report') {
                    document.getElementById('resetPlotSizes').dispatchEvent(new Event('click'));
                }
                document.getElementById(pageId).classList.add('active');
            });
        });

        // File upload functionality
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');


        // Draw button and progress bar functionality
        const drawButton = document.getElementById('drawButton');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const circumference = 2 * Math.PI * 54; // 2πr where r=54

        const colors = [
            '#004074', '#a0a0a0', '#cd5c5c', '#ff1493', '#dfdf0f', '#ffa500',
            '#ddaddd', '#ff00ff', '#9370DB', '#4b00b2', '#adff2f', '#90ee90',
            '#3cb371', '#66cdaa', '#008b0b', '#4682b4', '#7b68ee', '#005959',
            '#000080', '#ffdead', '#f4a460', '#d269e1', '#800000', '#2f4f4f',
            "#C42727", "#00A651", "#0066CC", "#FFCC00", "#CC00CC", "#00CCCC",
            "#A66633", "#663399", "#339966", "#993366", "#336699", "#999933",
            "#804040", "#408040", "#404080", "#808040", "#804080", "#408080",
            "#CC6666", "#66CC66", "#6666CC", "#CCCC66", "#CC66CC", "#66CCCC",
            "#E67333", "#33E673", "#3333E6", "#E6E633", "#E633E6", "#33E6E6",
            "#B38066", "#66B380", "#8066B3", "#B3B380", "#B380B3", "#66B3B3",
            "#BF4040", "#4DBF4D", "#4D4DBF", "#BFBF40", "#BF40BF", "#40BFBF",
            "#F28C8C", "#8CF28C", "#8C8CF2", "#F2F28C", "#F28CF2", "#8CF2F2"
        ];

        const grid = document.getElementById('color-grid');
        let verticalColorSelect = document.getElementById('verticalColorSelect');
        const verticalSelect = document.getElementById('verticalSelect');
        const groupType = document.getElementById('selectGroupType');
        // Function to calculate luminance to determine text color
        function getLuminance(hexColor) {
            const rgb = parseInt(hexColor.slice(1), 16);
            const r = (rgb >> 16) & 0xff;
            const g = (rgb >> 8) & 0xff;
            const b = (rgb >> 0) & 0xff;
            // Using sRGB luminance formula
            return 0.2126 * r + 0.7152 * g + 0.0722 * b;
        }

        colors.forEach(hex => {
            const box = document.createElement('div');
            const optVert = document.createElement('option');
            box.className = 'color-box';
            box.style.backgroundColor = hex;
            optVert.innerText = hex;
            optVert.value = hex;
            optVert.style.backgroundColor = hex;
            
            const label = document.createElement('span');
            label.className = 'color-label';
            label.textContent = hex;

            // Determine if black or white text is more readable
            const luminance = getLuminance(hex);
            label.style.color = luminance > 128 ? '#000000' : '#FFFFFF';
            optVert.style.color = luminance > 128 ? '#000000' : '#FFFFFF';
            box.appendChild(label);

            grid.appendChild(box);

            verticalColorSelect.appendChild(optVert);
        });

        document.getElementById('detailBlock').querySelector('.block-header').addEventListener('click', () => {
            let content = document.getElementById('detailBlock').querySelector('.styler');
            if (content.style.display === 'grid') {
                content.style.display = 'none';
            } else {
                content.style.display = 'grid';
            }
        })

        verticalSelect.addEventListener('change', () => {
            const fromElement = document.getElementById('fromWhere');
            const toElement = document.getElementById('toWhere');
            if (verticalSelect.value === 'pValue') {
                let newFrom = document.createElement('select');
                newFrom.id = fromElement.id;
                let newTo = document.createElement('select');
                newTo.id = toElement.id;
                const fromStyles = getComputedStyle(fromElement);
                const toStyles = getComputedStyle(toElement);
                const plotlyPlot = document.getElementById('plotlyPlot');
                const xTicks = plotlyPlot.layout.xaxis.tickvals;
                const xText = plotlyPlot.layout.xaxis.ticktext;
                for (let i = 0; i < fromStyles.length; i++) {
                    const prop = fromStyles[i];
                    newFrom.style[prop] = fromStyles.getPropertyValue(prop);
                };
                for (let i = 0; i < toStyles.length; i++) {
                    const prop = toStyles[i];
                    newTo.style[prop] = toStyles.getPropertyValue(prop);
                };
                xTicks.forEach(tick => {
                    let fromOpt = document.createElement('option');
                    let toOpt = document.createElement('option');
                    fromOpt.value = tick; fromOpt.text = xText[tick];
                    toOpt.value = tick; toOpt.text = xText[tick];
                    newFrom.appendChild(fromOpt); newTo.appendChild(toOpt);
                });
                fromElement.replaceWith(newFrom);
                toElement.replaceWith(newTo);
            } else {
                if (fromElement.tagName === 'SELECT') {
                    let newFrom = document.createElement('input');
                    newFrom.id = fromElement.id;
                    let newTo = document.createElement('input');
                    newTo.id = toElement.id;
                    const fromStyles = getComputedStyle(fromElement);
                    const toStyles = getComputedStyle(toElement);
                    for (let i = 0; i < fromStyles.length; i++) {
                        const prop = fromStyles[i];
                        newFrom.style[prop] = fromStyles.getPropertyValue(prop);
                    };
                    for (let i = 0; i < toStyles.length; i++) {
                        const prop = toStyles[i];
                        newTo.style[prop] = toStyles.getPropertyValue(prop);
                    };
                    newFrom.placeholder = 'Откуда';
                    newTo.placeholder = 'Куда';
                    fromElement.replaceWith(newFrom);
                    toElement.replaceWith(newTo)
                }
            }
        })
        groupType.addEventListener('change', () => {
            document.getElementById('selectGroupColor').value = groupType.value;
        })
        /*
        drawButton.addEventListener('click', function () {

            // Reset progress
            progressBar.style.strokeDashoffset = circumference;
            progressText.textContent = '0%';

            // Simulate progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += 2;
                if (progress > 100) {
                    clearInterval(interval);
                    progressText.textContent = 'Done!';
                    setTimeout(() => {
                        progressText.textContent = '0%';
                        progressBar.style.strokeDashoffset = circumference;
                    }, 2000);
                    return;
                }

                const offset = circumference - (progress / 100) * circumference;
                progressBar.style.strokeDashoffset = offset;
                progressText.textContent = `${progress}%`;
            }, 50);
        });*/
    </script>
</body>
</html>